# 使用规范

## 参考博文

1. [Redis 很屌，不懂使用规范就糟蹋了 - 掘金](https://juejin.cn/post/7037025652515536927)

2. [php 字符串压缩方法比较_php serialize会压缩数据吗_傲雪星枫的博客-CSDN博客](https://blog.csdn.net/fdipzone/article/details/18368577)

3. [Redis中SDS的最大长度限制真的是512MB吗？ - da^da - 博客园](https://www.cnblogs.com/to-make-life-better/p/16015630.html)

4. [Redis危险命令重命名、禁用_一世琥珀色的博客-CSDN博客](https://blog.csdn.net/weixin_zjmgly/article/details/53692106)

## 边界值

1. `Redis`最多可以容纳`2^32 - 1`个`key`，也就是`42.94`亿个元素

2. 单个元素包括`key，value，list，memeber`，最大支持`512MB`。这个是`Redis`在代码层面做的硬性要求，估计是`512MB`确实已经足够大了，再大就不适合在`Redis`里操作了。`SDS`里`3.2`版本字符串的长度是`32`位整形，最大可以表示`2^32/8/1024/1024 = 512MB`，后续该字段为`64`位可以支持更大的字符串，但是`512MB`已经足够大了，要考虑序列化和集群速度也就继续保持该限制。

3. 集合，列表类型，元素最多支持`2^32 - 1`个，`42.94`亿

4. 单实例`QPS`可达`12w+`，随着链接数的增多而减少，`1w`链接有`8w+`，`6w`链接接近`5w+`

5. 最大支持`2^14`个`slot`，也即`hash`槽，可以有`16384`个分布式实例，通过`CRC16`校验后取模再决定放哪个`hash`槽

## 使用规范

1. `key`要充分利用好前缀，看名知意
   
   > 1. `Redis`没有`Scheme`，针对`MySQL`映射：`数据库:表名:字段:ID`
   > 
   > 2. 其他场景要规范好前缀名，能通过前缀快速知道是干什么用的

2. `key`不要太长，一般限制在`100`个字符以内，充分用好缩写
   
   > 1. 多个前缀用冒号相连，能缩写的尽量缩写
   > 
   > 2. `Redis`前缀`key`统一管理，写好备注
   > 
   > 3. 有些后缀太长的可以考虑使用`hash`转化为`32`位或者`16`位

3. `Strings`类型的`value`不要太大，限制在`10kb`以内
   
   > 1. 可以考虑压缩后存入`Redis`，可以使用`gzcompress`压缩，若是对象数组可以使用`igbinary_serialize`进行序列化
   > 
   > 2. 若字符串即使压缩了依然还是非常大，可以考虑把大字符串存到其他地方，`Redis`只提供一个链接，比如存放在`OSS`之类的
   > 
   > 3. 或者是否可以利用骚操作，存入`Hashes`类型，然后逐个取出来再拼接，这里依然存在一次性取太多阻塞其他客户端的风险

4. 集合、队列类型，要控制里面元素的个数，尽量限制在`5000`个以内
   
   > 1. 理论上可以存`2^32 - 1`个元素，只受限于物理内存，但是随着元素个数的增长，部分命令的执行时间也随之增大，极易造成阻塞
   > 
   > 2. 可以考虑做水平拆分，把大`key`拆分为多个小`key`

5. 谨慎使用部分命令
   
   > 1. 多查看文档，必须清晰的知道所使用的命令的时间复杂度是多少，是否有正确使用命令
   > 
   > 2. 线上禁用命令：`keys`、`flushdb`、`flushall`、`config`。再配置文件里使用`rename-command`命令进行限制
   > 
   > 3. 几个需要重点关注的命令：全量命令都需谨慎使用，因为里面的元素无法预估，极易造成阻塞，`hgetall`、`lrange`、`smembers`、`zrange`
   > 
   > 4. 可以使用分批执行的方式来达到获取所有的目的，比如`keys`可以用`scan`代替，用分页思维来逐页获取全量数据。类似的还有有`hscan`、`zscan`、`sscan`

6. 尽量给每一个`key`设置过期时间
   
   > 1. 除开少部分内存永驻的`key`，每个`key`都要设置一个合理的过期时间
   > 
   > 2. 为了避免雪崩，在设置过期时间时，如果允许的话，需在过期时间的基础上再加一个随机值，避免大批量`key`同时到期

7. `ACID`，一般避免在`Redis`执行`ACID`的场景
   
   > 1. `Redis`的`ACID`是存在问题的，部分支持原子性(不可回退)、不支持`ACID`的一致性、具备隔离性(`watch`)、无法保证持久性(`RDB`、`AOF`都不能保证)
   > 
   > 2. 可使用`Lua`脚本来实现，把所有命令打包执行

8. 安全问题要注意
   
   > 1. `protected-model yes`必须开启
   > 
   > 2. 必须设置密码，且密码不可设置的太简单，可以随机生成一串字符串，`requirepass passwordxxx`
   > 
   > 3. IP白名单，可以使用`iptables`来限制只有指定的`IP`可以访问`Redis`，或者`bind`指定`IP`