# MQ消息堆积

## 参考资料

1. [【面试拿来即用系列】你遇到过什么线上问题，如何解决的？（三） - 掘金](https://juejin.cn/post/7248452815265611813)

## 坑

1. 突发消息堆积

## 可能的原因

1. 生产者消息突然增多

2. 消费者突然bug或者异常，导致消费变慢

3. 两者兼而有之

## 排查

1. 查看生产者是否正常，QPS是否有突发

2. 查看消费者是否有错误异常等日志

## 本案例问题

1. MQ队列大部分路由到了同一个broker，导致该broker消费不及时

2. 这里需要修改路由规则，把数据更加均匀的分到各broker

3. 路由算法由雪花算法ID进行取余，由于生成的ID规则缘故，大部分ID取余后都路由到了0这个编号的broker

## 解决

1. 修改路由规则，增加一层算法，把数据变得更加随机，对原ID进行hash再取余