# 两个事务并发写，能保证数据唯一吗？

## 参考资料

1. [两个事务并发写，能保证数据唯一吗？ - 掘金](https://juejin.cn/post/7168632493767065630)

## 坑

1. 开启事务进行竞争插入，但是依然存在重复数据

## 分析

1. 一般我们都是先`select`再`insert`，若此时我们开了事务，是可以做到整体一致性

2. 但是`select`是支持并发查询的，也即两个线程并发`select`都是无，然后又会并发的`insert`，这样就出现重复数据了

## 解决

1. 引入分布式锁，获取到锁才可以进行插入操作，当然也相应的增加了复杂度

2. 如果没有分布式锁，或者做一个保底，在`MySQL`里加一个唯一锁，这样就可以从根上解决问题，但是如果由于某种原因不太方便加索引则我们依然需要分布式锁

## 扩展

1. `MySQL`在读写数据时会利用一个中间层，也即`buffer pool`，直接在内存里进行操作，然后再异步写入磁盘，加快`MySQL`的读写速度

2. 针对写操作又独立设计了`change buffer`，只记录需要变更的那条数据即可，无需记录数据页(`buffer pool`会以页为单位加载一个个数据页)

3. 针对唯一索引时，会去磁盘读取索引树加载到`buffer pool`，用于判断是否唯一，这里多了一步加载判断逻辑自然比普通索引会慢一点