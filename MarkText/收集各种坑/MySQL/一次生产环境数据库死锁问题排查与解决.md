# 一次生产环境数据库死锁问题排查与解决

## 参考资料

1. [一次生产环境数据库死锁问题排查与解决 - 掘金](https://juejin.cn/post/7265995969689780283)

## 如何有效的避免死锁的发生：

1. 设置事务等待锁的超时时间。当一个事务的等待时间超过该值后，就对这个事务进行回滚，于是锁就释放了，另一个事务就可以继续执行了。在 `InnoDB` 中，参数 `innodb_lock_wait_timeout` 是用来设置超时时间的，默认值时 `50` 秒。

2. 开启主动死锁检测。主动死锁检测在发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 `innodb_deadlock_detect` 设置为 `on`，表示开启这个逻辑，默认就开启。

3. 修改数据库隔离级别为`RC`，`MySql`默认级别为`RR`，`RC`没有间隙锁`Gap Lock`和组合锁`Next-Key Lock`，能一定程度的避免死锁的发生。

4. 尽量少使用当前读`for update`，数据更新时尽量使用主键。