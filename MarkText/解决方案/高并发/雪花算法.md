# 雪花算法

## 参考资料

1. [数据库主键一定要自增的吗？有哪些场景下不建议自增？ - 掘金](https://juejin.cn/post/7168638701784793124)

## 概念

1. 由Twitter开源的UUID算法

2. 总64个bit位，第一位预留置0；接下来41位为时间戳，精确到毫秒；10位工作机器ID；12位序列号，也即当前机器生成的递增数字

![雪花算法](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/225fde709bae4574ad77b0deba6f37c1~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

## 魔改一

> 采用10进制，总32位，此处要用string来存储了。
> 
> 12位时间，到秒；10位工作IP的10进制；6位序列号，也即自增ID；2位分库ID；2位分表ID。
> 
> 由于采用了IP来替换上面的工作机器ID，可以根据简单直接的获取到机器标记。
> 
> 另外加上了分库分表标记，便于快速找到表所在

![适合分库分表的uuid算法](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/efe8b754aa7842369c8fe7f873162229~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

## 魔改二

1. 在49-56这8个bit位里做分表分库的标记

2. 分表分库为了让数据更加均匀，需对分库分表的数据进行hash再取模

> 此处有个小知识点，若取模时是对2的进制数取模，a%b 等价于 a&(b-1)，比如10%8 => 10&7，其中8是2的3次方，10%7 就不能等同于 10&6了

## 问题

1. 由于采用了时间戳，存在时钟回拨的问题