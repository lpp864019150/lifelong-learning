# 深分页优化

## 参考博文

1. [千万级数据深分页查询SQL性能优化实践 | 京东云技术团队 - 掘金](https://juejin.cn/post/7270114845403316263)
2. [【得物技术】MySQL深分页优化 - 掘金](https://juejin.cn/post/6985478936683610149)

## 坑

1. 传统的分页都是利用`MySQL`的`limit offset, limit`进行分页，这样逻辑简单清晰，一般不会有什么问题，但是一旦页码大了，就会变慢

2. 这是因为`limit`的执行逻辑是先遍历，然后舍弃`offset`最后返回`limit`，也即会遍历`offset+limit`行数据，页码越大遍历越多自然也就越慢

## 可能的原因

1. 回表
   
   在查询的过程中一般我们都会使用索引，但是若查询里的字段还有索引不包含的字段，则在查询的过程中需要根据主键id回到主键索引去再查一次，把需要用到的所有字段都补齐才能完成一行数据的查询，这个回到主键索引查数据的过程就叫做回表。若每一行都不能完全由索引完成则每一行的查询都需要进行一次回表。

2. 随机IO
   
   众所周知，MySQL的数据是放在磁盘里的，取数据时需要从磁盘里获取，每次获取都会产生一次磁盘IO，这个过程在SQL查询里是非常耗时的。若一次磁盘IO不能把当次查询的数据都拿出来则会产生多次磁盘IO。根据上面回表的描述，极有可能针对每一行数据都会产生一次磁盘IO。

3. Limit offset, limit机制
   
   MySQL的limit机制会扫描offset+limit行数据，然后再舍弃掉offset行，只返回limit行。这是因为MySQL一开始无法直接定位到offset，需要一行一行扫描到offset才知道结果集由此开始。这个进制就会导致深分页扫描非常多行无用数据，若需要回表则极有可能每一行都产生一次磁盘IO，想想都觉得可怕。

4. 全表扫描
   
   有时即使有索引也不一定会走索引，当MySQL优化器认为走索引并不能提升性能时会放弃索引直接进行全表扫描。这里可能是搜索结果占整表数据的比例过大，也可能回表此时过多照成的性能问题。

## 解决方案

### 技术方案

1. 延迟关联
   
   先搜索出来主键，再联表进行查询
   
   只搜索主键`id`肯定比`select`多个字段要快，但是这个效果也不一定很好，毕竟依然是深分页，依然会遍历`offset+limit`条记录，若能做到不回表或者少回表则能大大加快查询速度
   
   `select * from table inner jion(select id from table where order by id desc limit 10000, 10) t using(id)`

2. 使用标签记录法
   
   这里其实就是变相把深分页变成了浅分页，自然效率就上来了
   
   先记录上一次的最后一条排序字段的值(或者主键id值，然后通过主键`id`反查即可)，在下一次搜索时带上进行范围限制，这样可以快速定位到开始的地方，避免了无效的`offset`扫描并舍弃的步骤
   
   但是这里存在一个问题，在最后一页时，依然会遍历剩下的全表直到无结果，也即这里的`last_xx`只能缩小开始的范围并不能限制结束的范围
   
   `id<lastId order by id desc limit 100`

3. 区间限制法
   
   基于上面标签记录法无法在最后一页快速结束的缺点，需要再增加一个结束范围，这样就无需遍历全表来查找最后一页的结果集
   
   但是这里也存在一个问题，需要去维护另外一个边界值，有时获得这个边界值会非常耗时，需要采取异步的方案，甚至要借用离线大数据来维护该值
   
   `id<lastId and id>minId order by id desc limit 100`

4. 分表
   
   将表变小，自然就不惧怕深分页了，但是分表之后又增加了查询的复杂性，原本只需一条SQL就解决的问题可能需要在多表里分多条SQL，同时分表也增加了整个程序的复杂度，还涉及到修改业务流程等问题，不到万不得已切不可分表

5. 使用其他数据库方案
   
   比如ES，OLAP数据库，这些数据库对深分页的支持比较好，当然如果页码依然非常大，这些数据库也依然会存在瓶颈，此时我们是否应该思考我们的需求场景是否合理，不能为了技术而技术
   
   这里就涉及到数据同步以及增加了额外的服务器费用，需要考虑代价问题

### 业务方案

1. 尽量采用不跳页来分页，这样可以考虑使用标签记录法一页一页往下翻，自然不会有深分页问题

2. 即使需要翻页可以学google和百度，每次只有上下10页可以跳，想要达到深分页就不会那么容易了；另外改方案我们依然可以使用浅分页来解决，一次性取10页的数据出来再程序里分10页

3. 可以考虑限制最大分页，若需查看更多，配合查询条件，把查询结果集限制在更小的范围，比如增加基于时间范围的查询，若某个时间范围超过了1000页则提示已达最大页码，若需查看更多需用户重新选择时间范围来查看
