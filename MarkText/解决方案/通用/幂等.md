# 幂等

## 什么是幂等

> **幂等**是一个数学与计算机学概念，在数学中某一元运算为幂等时，其作用在任一元素两次后会和其作用一次的结果相同。

> 在计算机中编程中，一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。

> 幂等函数或幂等方法是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。

## 场景

1. **前端重复提交表单**： 在填写一些表格时候，用户填写完成提交，很多时候会因网络波动没有及时对用户做出提交成功响应，致使用户认为没有成功提交，然后一直点提交按钮，这时就会发生重复提交表单请求。

2. **用户恶意进行刷单**： 例如在实现用户投票这种功能时，如果用户针对一个用户进行重复提交投票，这样会导致接口接收到用户重复提交的投票信息，这样会使投票结果与事实严重不符。

3. **接口超时重复提交**：很多时候 HTTP 客户端工具都默认开启超时重试的机制，尤其是第三方调用接口时候，为了防止网络波动超时等造成的请求失败，都会添加重试机制，导致一个请求提交多次。

4. **消息进行重复消费**： 当使用 MQ 消息中间件时候，如果发生消息中间件出现错误未及时提交消费信息，导致发生重复消费。

## 解决方案

1. 数据库唯一主键
   
   利用唯一键先去数据库搜索一遍，若存在则update，不存在则新增。
   
   也可简单粗暴的用 `insert into on duplicate key update xx;`，但是要注意使用场景，一般不建议使用，慎用。

2. 数据库乐观锁
   
   `CAS`，`update xx set version=version+1 where id=x and version=x;`时加一个版本号限制，防止无效`update`更新数据

3. Redis互斥锁、分布式锁
   
   不存在时则可操作，注意要加上过期时间，避免死锁，`set(key, 1, ['nx', 'ttl' => 1800])`，若某个操作非常耗时，或者耗时不可控，这个方案会存在一定的问题

4. 前端控制请求
   
   按钮置灰，短时间内不可重复操作

5. PRG模式
   
   `Post->Redirect->Get`，处理完进行重定向到结果页，跳开重复操作的页面

6. 单服务单进程
   
   可利用Linux本身的特性，在执行时检测当前进程数，一般要注意通过特有字符来判断，避免匹配到其他进程，`ps -ef | grep xx | grep -v grep | wc -l`

7. 防重Token令牌
   
   可以在每次操作时先请求一个令牌，后续操作时带上该令牌，防止多次重复的直接提交，每个令牌在第一次提交使用完后清空。
   
   这里也要借助Redis的互斥锁，在第一次提交时，查询是否存在并删除，这里有两个步骤，如何保证原子性，这里提供一个方案，del 时是否返回>0，则为存在且已删除

## 总结

1. 需要结合业务逻辑，搞清楚到底为什么会出现幂等问题

2. 基于业务逻辑以及当前的技术栈来选择一个比较合理的解决方案

3. 通用解决方案为Redis锁，设计好key的规则以及超时时间，大部分场景都可通用

4. 某些场景需要单机单进程执行，可借助shell命令来判断是否单进程执行

## 真实案例分享

1. 重复多次执行的脚本，比如统计报表
   
   这里一般是借助数据库的唯一索引特性，一般我们会先根据唯一索引来查数据是否存在，不存在则新增一条，否则更新数据。

2. 不可重复多次执行的脚本，比如拉取第三方数据
   
   此时我们一般会借助锁，先上锁，来开始同步，由于时间不可控，锁的过期时间是个比较大的问题，短了会出现两个脚本同时跑，长了若脚本出现问题未解锁则会导致一直无法跑新的脚本。
   
   这里可以考虑定时开启脚本，然后在脚本里监控是否已有再跑的脚本，若有则退出，定时间隔可设置为每分钟执行。

3. 接口重复操作
   
   操作+用户ID作为key设置一个互斥锁，对于C端来说一般的操作是在毫秒级，最大不会超过30s，因此我们可以借助Redis来实现该互斥锁，在用户执行时获取锁，操作结束(失败或成功)进行结束，超时时间设置为5分钟防止死锁

4. 生成唯一ID
   
   可借助Redis的自增ID来实现，每次生成一个ID时都会先自增一次Redis的ID，然后取他的值来生成唯一ID

## 参考文档

1. [一口气说出四种幂等性解决方案，面试官露出了姨母笑~ - 掘金](https://juejin.cn/post/6906290538761158670)

2. [这8种解决重复提交的方案，你知道哪几种？ - 掘金](https://juejin.cn/post/7002020918671179790)
